---
title: "Índice Valor Importancia"
author: "Paul Efren Santos Andrade"
date: 2018-10-05
categories: ["R"]
tags: ["Dataviz", "Plant diversity", "Data management"]
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
library(tidyverse)
library(knitr)
library(vegan)
library(here)
data("BCI")
```


## Los paquetes en R:

- *tidyverse* proporciona herramientas para el manejo y análisis de datos, se compone de múltiples paquetes que tienen una gramática común.

```{r, echo=TRUE}
#install.packages("tidyverse")
#install.packages("knitr")
library(tidyverse)
library(knitr)
```


## La base de datos:

Para este ejemplo modificamos la información  de la base de datos **BCI** del paquete `vegan`.

```{r, echo=FALSE, include=FALSE}
a <- BCI %>%
  as_tibble() %>%
  rownames_to_column("parcela") %>%
  gather(especies, abundancea,-parcela) %>% 
  filter(abundancea != 0) %>% 
  as.data.frame()


data <- data_frame(especies = rep(a$especies, a$abundancea),
                   parcela = rep(a$parcela, a$abundancea))  %>% 
  mutate(dap = runif(length(especies), min = 10, max = 60),
         a_basal = runif(length(especies), min = 79.2, max = 2900)) %>% 
  select(parcela, especies, dap, a_basal) %>% 
  group_by(parcela) %>% 
  arrange(parcela) %>% 
  ungroup()
```

```{r echo=FALSE}
head(data) %>% kable(
  col.names = c("Parcela", "Especie", "DAP",
                "Area basal"))
```

Estos datos fueron generados aleatoriamente para este ejemplo, no corresponden a ningún inventario real.  Se toma como modelo la información colectada en una parcela de 1ha; dividida en 25 sub parcelas, en las cuales se tiene el registro de cada uno de los individuos encontrados en esta e identificados a nivel de especie.


## Conociendo nuestros datos:

Una vez que tenemos los datos en R es necesario revisar algunas características básicas de estos; el comando *dim()*, nos permite conocer el número de observaciones y variables que contiene el *dataframe*.

```{r, echo=TRUE}
dim(data)
```

El comando *head()* nos permitirá revisar la información contenida en las primeras seis filas de nuestra base de datos.

```{r, echo=TRUE, eval=FALSE}
head(data)
```

```{r echo=FALSE}
head(data) %>% kable()
```


Mientras el comando *tail()* nos permitirá evaluar la información contenida en las últimas seis filas del dataframe. 
```{r, eval=FALSE, include=TRUE}
tail(data)
```

```{r echo=FALSE}
tail(data) %>% kable()
```


Si buscamos conocer cuáles son las observaciones que corresponden a la sub parcela número 1 podemos hacerlo con el siguiente código: 

```{r, eval=FALSE}
data[which(data$parcela == 1),]
```


Podemos conseguir el mismo resultado con la función *filter()* del paquete *dplyr*:

```{r eval=FALSE}
data %>%
  filter(parcela == 1)
```

```{r echo=FALSE}
data %>% 
  filter(parcela == 1) %>% 
  head(n = 10) %>% 
  kable()
```

## Índice de valor de importancia:

Las comunidades vegetales están compuestas por un grupo de especies, cada una con una abundancia diferente. Todas las especies compiten por acceder a recursos (agua, luz, CO2, etc.), las especies que mejor aprovechen estos recursos serán las que dominen la comunidad, determinando su estructura. La forma como estas aprovechen la energía del sistema nos permitirá conocer el comportamiento ecológico de la comunidad, esto se puede realizar mediante el cálculo de los valores de importancia de cada especie. 

El índice de valor de inportancia (`IVI`) define como de las especies presentes en la comunidad contribuyen en el carácter y estructura de un ecosistema [(Cottam y Curtis,1956)](http://cescos.fau.edu/gawliklab/papers/CottamGandJTCurtis1956.pdf). Este valor se obtiene mediante la sumatoria de la frecuencia relativa, la densidad relativa y la dominancia relativa.


### Densidad y Frecuencia absoluta:

- El primer paso para determinar el valor del IVI, es conocer el número de individuos por especie  y el número de sub parcelas en las cuales está presente esta. Esto podemos obtenerlo mediante el siguiente código.

```{r eval=FALSE}
data %>%
  group_by(especies) %>% 
  summarise(
  n_individuos = n(),# número de individuos de la especie "i".
  n_suplot = n_distinct(parcela),#número de sub parcelas en las que esta presente la especie.
  area_basal = sum(a_basal)# area basal total de la especie "i".
  )
```

```{r echo=FALSE}
data %>%
  group_by(especies) %>% 
  summarise(
  n_individuos = n(),# número de individuos de la especie "i".
  n_suplot = n_distinct(parcela),#número de sub parcelas en las que esta presente la especie.
  area_basal = sum(a_basal)# area basal total de la especie "i".
  ) %>% 
  head() %>% 
  kable(col.names = c("Especie", "Indi. por especie",
                      "Frecuencia", "Area basal"))
```

### Densidad, Frecuencia y Dominancia Relativa:

#### Densidad relativa: `DR`

- O abundancia relativa, es el número de individuos de una especie dividida entre el número total de individuos de la comunidad multiplicado por cien.

#### Frecuencia relativa: `FR`

Es la frecuencia (número de sub parcelas en las cuales ocurre la especie) dividida por la suma de las frecuencias de todas las especies, multiplicado por cien.

#### Dominancia relativa: `DmR`

La dominancia se mide en función al área basal  (es el área en m² que ocupa un corte transversal del tronco) de cada una de las especies, se calcula dividiendo el área basal de la especie por la sumatoria de las áreas basales de todas las especies presentes en la parcela, multiplicándola por cien.

- Finalmente el valor de importancia: `IVI`

                     IVI = (DR + FR + DmR)/3

Las siguientes líneas nos permiten determinar cada uno de los valores antes mencionados. Para no desplegar toda la tabla solo se mostraran las diez especies con mayor valor de importancia.
 
```{r eval=FALSE}
install.packages("devtools") 
devtools::install_github("PaulESantos/diversity.tool")
library(diversity.tool)

data %>% 
  ivi_index()
```


```{r echo=FALSE}
data %>%
  group_by(especies) %>% 
  summarise(n_individuos = n(),
            n_suplot = n_distinct(parcela),
            area_basal = sum(a_basal)) %>% 
  mutate(dens_rela = (n_individuos/sum(n_individuos))*100,
         frec_rela = (n_suplot/ sum(n_suplot))*100,
         dom_rela = (area_basal/sum(area_basal))*100) %>% 
  rowwise() %>% 
  mutate(ivi = (sum(dens_rela, frec_rela, dom_rela)/3)) %>% 
  arrange(desc(ivi)) %>% 
  select(-c(2:4)) %>% 
  head(n = 10) %>% 
  kable(col.names = c("Especie", "DR",
                      "FR", "DmR", "IVI"))
```

## Clases dimétricas: 

- Para determinar las clases dimétricas, es necesario conocer el rango en el cual varia el DAP de los árboles,  así podemos determinar el número de clases con la cual deseamos trabajar.

```{r, eval=FALSE}
data %>% summarise(Dap_min = min(dap),
                   Dap_max = max(dap),
                   Ramgo = Dap_max - Dap_min) 
```


```{r echo=FALSE}
data %>% summarise(Dap_min = min(dap),
                   Dap_max = max(dap),
                   Ramgo = Dap_max - Dap_min) %>% 
  kable()
```


- Se puede ver que el DAP varía entre 10 y  59.7. El rango de los datos es 50, podemos determinar por ejemplo cinco clases dimétricas cada 10 cm:


```{r echo=FALSE}
data_frame(Intervalo = c("10 - 20", "20 - 30", "30 - 40", 
                         "40 - 50", "50 - 60", "..."),
           Clase = c("Clase 1", "Clase 2", "Clase 3",
                     "Clase 4", "Clase 5", "Clase ...")) %>% 
  kable()
```


- Las siguientes líneas crean una nueva columna en el dataframe (base de datos), asignando cada una de las observaciones a una de las clases dimétricas:
 
```{r eval=FALSE}
# Creamos un nuevo dataframe con la columna diam_class y la asignamos al objeto clase_diametrica.
clase_diametrica <- data %>% 
  mutate(
    diam_class = case_when(
      dap >= 10 & dap < 20 ~ "Clase_1",
      dap >= 20 & dap < 30 ~ "Clase_2",
      dap >= 30 & dap < 40 ~ "Clase_3",
      dap >= 40 & dap < 50 ~ "Clase_4",
      dap >= 50 & dap < 60 ~ "Clase_5",
      is.na(dap) ~ "sin DAP" ))

```


```{r echo=FALSE}
# Creamos un nuevo dataframe con la columna diam_class y la asignamos al objeto clase_diametrica.
clase_diametrica <- data %>% 
  mutate(
    diam_class = case_when(
      dap >= 10 & dap < 20 ~ "Clase_1",
      dap >= 20 & dap < 30 ~ "Clase_2",
      dap >= 30 & dap < 40 ~ "Clase_3",
      dap >= 40 & dap < 50 ~ "Clase_4",
      dap >= 50 & dap < 60 ~ "Clase_5",
      is.na(dap) ~ "sin DAP" ))

## Retorna las diez primeras observaciones del nuevo dataframe.
clase_diametrica %>% 
  head(n = 10) %>% 
  kable(col.names = c("Sub parcela","Especie", "DAP", "Area basal", "Clase diametrica"))
```

- La primera clase *(Clase 1)* dimétricas está conformada por todos los arboles con un DAP entre 10 y  20 cm, el código incluye en este grupo todos los arboles con un DAP  mayor igual a 10 y menor a 20. (`dap >= 10 & dap < 20 ~ "Clase_1"`).

- El siguiente código genera una tabla resumen con los valores mínimos, máximos, rango y número de individuos por cada clase dimétricas.

```{r eval=FALSE}
clase_diametrica %>%  
group_by(diam_class) %>% 
  summarise(min = min(dap),
            max = max(dap), 
            rango =max- min,
            n = n()) 
```



```{r echo=FALSE}
clase_diametrica %>%  
group_by(diam_class) %>% 
  summarise(min = min(dap),
            max = max(dap), 
            rango =max- min,
            n = n()) %>% 
  kable(col.names = c("Clase diametrica", "Min_DAP", "Max_DAP",
                      "Rango", "N_individuos"))
```


- La representación gráfica de las clases dimétricas la obtendremos mediante las siguientes líneas de código: 

```{r echo=TRUE}
clase_diametrica %>%
  group_by(diam_class) %>% 
  summarise(min = min(dap),
            max = max(dap), 
            rango =max- min,
            n = n()) %>% 
  ggplot(aes(diam_class, n)) +
  geom_point(size = 5, color = "red")+
  geom_line(aes(c(1:5), n), linetype = "dashed")+
  theme_bw()+
  scale_y_continuous(breaks=seq(75,150,5))+
  theme(axis.text.x  = element_text(angle=0, vjust=0.5, 
                                    size=11, face = "bold"),
        axis.text.y.left  = element_text(angle = 0, vjust = .5,
                                         size = 11, face = "bold"), 
        axis.title.y = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        plot.title = element_text(hjust = .5, face = "bold"))+
  labs(x = "Clase Diametrica", 
       y = "Número de individuos",
       title = "Estructura Dimétrica")

```
